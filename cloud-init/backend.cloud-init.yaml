#cloud-config
package_update: true
package_upgrade: true

packages:
  - ca-certificates
  - curl
  - git

write_files:
  - path: /etc/systemd/system/backend.service
    content: |
      [Unit]
      Description=Node.js Backend API
      After=network.target

      [Service]
      Type=simple
      User=root
      WorkingDirectory=/opt/app/backend
      ExecStart=/usr/bin/node /opt/app/backend/server.js
      Restart=on-failure
      RestartSec=10
      Environment=NODE_ENV=production
      Environment=PORT=3000

      [Install]
      WantedBy=multi-user.target
    owner: root:root
    permissions: '0644'

runcmd:
  # Install Node.js 20.x LTS
  - curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
  - apt-get install -y nodejs
  # Clone the repository
  - git clone https://github.com/cloudhelden-09-25/nodejs-react-reverse-proxy.git /opt/app
  # Install dependencies
  - cd /opt/app/backend && npm install
  # Enable and start the backend service
  - systemctl daemon-reload
  - systemctl enable backend.service
  - systemctl start backend.service
