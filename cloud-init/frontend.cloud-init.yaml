#cloud-config
package_update: true
package_upgrade: true

packages:
  - ca-certificates
  - curl
  - git
  - nginx

write_files:
  - path: /etc/nginx/sites-available/frontend
    content: |
      server {
          listen 80 default_server;
          listen [::]:80 default_server;
          root /var/www/frontend;
          index index.html;
          server_name _;

          location / {
              try_files $uri $uri/ /index.html;
          }
      }
    owner: root:root
    permissions: '0644'

runcmd:
  # Install Node.js 20.x LTS
  - curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
  - apt-get install -y nodejs
  # Clone the repository
  - git clone https://github.com/cloudhelden-09-25/nodejs-react-reverse-proxy.git /opt/app
  # Install dependencies and build
  - cd /opt/app/frontend && npm install
  - cd /opt/app/frontend && npm run build
  # Copy build output to nginx directory
  - mkdir -p /var/www/frontend
  - cp -r /opt/app/frontend/dist/* /var/www/frontend/
  # Configure nginx
  - rm -f /etc/nginx/sites-enabled/default
  - ln -sf /etc/nginx/sites-available/frontend /etc/nginx/sites-enabled/frontend
  - nginx -t && systemctl restart nginx
